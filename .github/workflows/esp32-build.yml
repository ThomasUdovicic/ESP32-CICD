name: ESP32 Firmware CI

on:
    push:
        branches: [ main, develop, feature/** ]
        tags: [ 'v*' ]
    pull_request:

jobs:
    lint:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install clang-format
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-format

            - name: Check C/C++ formatting
              run: |
                  clang-format --style=file --dry-run --Werror main/xiao_button_blink.cpp

    test:
        needs: lint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install CMake and g++
              run: |
                sudo apt-get update
                sudo apt-get install -y cmake g++

            - name: Configure tests
              run: cmake -S tests -B build-tests

            - name: Build tests
              run: cmake --build build-tests --config Release

            - name: Run tests
              run: ctest --test-dir build-tests --output-on-failure

    build:
        needs: [lint, test]
        runs-on: ubuntu-latest
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Build with ESP-IDF
              uses: espressif/esp-idf-ci-action@v1
              with:
                    esp_idf_version: v5.1
                    target: esp32s3
                    path: .

            - name: Upload firmware artifacts
              uses: actions/upload-artifact@v4
              with:
                name: firmware-build
                path: |
                  build/**/*.bin
                  build/**/*.elf\

    deploy:
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: self-hosted

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install ESP-IDF
              uses: espressif/esp-idf-action@v1
              with:
                    version: v5.1

            - name: Build and flash firmware to device
              run: |
                  idf.py set-target esp32s3
                  idf.py -p /dev/cu.usbmodem2101 flash
        