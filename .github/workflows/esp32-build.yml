name: ESP32 Firmware CI

on:
    push:
        branches: [ main, develop, feature/** ]
    pull_request:

jobs:
    lint:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install clang-format
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-format

            - name: Check C/C++ formatting
              run: |
                  clang-format --dry-run --Werror main/xiao_button_blink.cpp

    build:
        needs: lint
        runs-on: ubuntu-latest
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Build with ESP-IDF
              uses: espressif/esp-idf-ci-action@v1
              with:
                    esp_idf_version: v5.1
                    target: esp32s3
                    path: .

            - name: Upload firmware artifacts
              uses: actions/upload-artifact@v4
              with:
                name: firmware-build
                path: |
                  build/**/*.bin
                  build/**/*.elf